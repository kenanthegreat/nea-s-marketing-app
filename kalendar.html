<!DOCTYPE html>
<html lang="hr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Akcije & Promocije | Na≈°i Restorani</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #f0f2f5;
  --card: #ffffff;
  --text: #1a1a2e;
  --text2: #64748b;
  --border: #e2e8f0;
  --today-bg: #3b82f6;
  --header-bg: linear-gradient(135deg, #1e293b 0%, #334155 100%);
  --akcija: #ef4444;
  --promocija: #22c55e;
  --happy_hour: #3b82f6;
  --event: #f97316;
  --novo_meni: #a855f7;
  --praznik: #eab308;
  --rodjendan: #ec4899;
  --posebna: #6366f1;
}
* { margin:0; padding:0; box-sizing:border-box; }
body { font-family:'Inter',system-ui,sans-serif; background:var(--bg); color:var(--text); min-height:100vh; }

/* HEADER */
.header {
  background:var(--header-bg); color:#fff; padding:20px 24px;
  text-align:center; position:sticky; top:0; z-index:100;
  box-shadow:0 4px 20px rgba(0,0,0,0.15);
}
.header h1 { font-size:1.5rem; font-weight:800; letter-spacing:-0.5px; }
.header p { font-size:0.85rem; opacity:0.7; margin-top:4px; }
.admin-entry {
  position:absolute; right:16px; top:16px;
  border:1px solid rgba(255,255,255,0.35); color:#fff;
  background:rgba(255,255,255,0.12); backdrop-filter:blur(4px);
  border-radius:20px; padding:8px 14px; font-size:0.8rem;
  font-weight:700; cursor:pointer; font-family:inherit;
}
.admin-entry:hover { background:rgba(255,255,255,0.2); }

/* FILTERS */
.filters {
  display:flex; gap:8px; padding:16px 24px; overflow-x:auto;
  background:#fff; border-bottom:1px solid var(--border);
  -webkit-overflow-scrolling:touch;
}
.filters::-webkit-scrollbar { display:none; }
.filter-btn {
  padding:8px 16px; border-radius:20px; border:2px solid var(--border);
  background:#fff; font-size:0.8rem; font-weight:600; cursor:pointer;
  white-space:nowrap; transition:all 0.2s; font-family:inherit;
}
.filter-btn:hover { border-color:var(--today-bg); color:var(--today-bg); }
.filter-btn.active {
  background:var(--today-bg); color:#fff; border-color:var(--today-bg);
}

/* NAVIGATION */
.nav-bar {
  display:flex; justify-content:center; align-items:center;
  gap:16px; padding:16px 24px;
}
.nav-btn {
  width:40px; height:40px; border-radius:50%; border:2px solid var(--border);
  background:#fff; cursor:pointer; font-size:1.1rem; display:flex;
  align-items:center; justify-content:center; transition:all 0.2s;
}
.nav-btn:hover { background:var(--today-bg); color:#fff; border-color:var(--today-bg); }
.nav-today {
  padding:8px 20px; border-radius:20px; border:2px solid var(--today-bg);
  background:#fff; color:var(--today-bg); font-weight:600; cursor:pointer;
  font-size:0.85rem; font-family:inherit; transition:all 0.2s;
}
.nav-today:hover { background:var(--today-bg); color:#fff; }

/* CALENDAR CONTAINER */
.calendars {
  display:grid; grid-template-columns:repeat(3,1fr);
  gap:16px; padding:0 24px 24px; max-width:1400px; margin:0 auto;
}
@media(max-width:1024px) { .calendars { grid-template-columns:1fr; max-width:500px; } }

/* MONTH CARD */
.month-card {
  background:var(--card); border-radius:16px;
  box-shadow:0 1px 3px rgba(0,0,0,0.08); overflow:hidden;
  transition:transform 0.2s, box-shadow 0.2s;
}
.month-card:hover { transform:translateY(-2px); box-shadow:0 8px 25px rgba(0,0,0,0.1); }
.month-card.center { box-shadow:0 4px 15px rgba(59,130,246,0.15); border:2px solid rgba(59,130,246,0.2); }
.month-header {
  padding:16px 20px; font-size:1.05rem; font-weight:700;
  text-align:center; border-bottom:1px solid var(--border);
}
.month-card.center .month-header {
  background:linear-gradient(135deg,#3b82f6,#6366f1); color:#fff;
}
.day-names {
  display:grid; grid-template-columns:repeat(7,1fr);
  padding:8px 8px 4px; gap:2px;
}
.day-name {
  text-align:center; font-size:0.7rem; font-weight:700;
  color:var(--text2); text-transform:uppercase; padding:4px;
}
.days-grid {
  display:grid; grid-template-columns:repeat(7,1fr);
  padding:0 8px 12px; gap:2px;
}
.day-cell {
  min-height:70px; height:70px; padding:4px; border-radius:8px;
  cursor:default; transition:background 0.15s; position:relative;
  overflow:hidden;
}
@media(max-width:1024px) { .day-cell { min-height:80px; height:80px; } }
.day-cell:hover { background:#f8fafc; }
.day-cell.empty { opacity:0.3; }
.day-cell.other-month .day-number { color:#cbd5e1; }
.day-number {
  font-size:0.8rem; font-weight:600; display:inline-flex;
  width:26px; height:26px; align-items:center; justify-content:center;
  border-radius:50%; margin-bottom:2px;
}
.day-cell.today .day-number {
  background:var(--today-bg); color:#fff;
  animation:pulse 2s infinite;
}
@keyframes pulse {
  0%,100% { box-shadow:0 0 0 0 rgba(59,130,246,0.4); }
  50% { box-shadow:0 0 0 6px rgba(59,130,246,0); }
}

/* EVENT PILLS */
.event-pill {
  font-size:0.65rem; font-weight:600; color:#fff;
  padding:2px 6px; border-radius:4px; margin-bottom:2px;
  white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
  cursor:pointer; transition:transform 0.15s, box-shadow 0.15s;
  line-height:1.4;
  display:block; width:100%; max-width:100%;
}
.event-pill:hover { transform:scale(1.05); box-shadow:0 2px 8px rgba(0,0,0,0.2); z-index:10; position:relative; }
.more-events {
  font-size:0.65rem; color:var(--today-bg); font-weight:600;
  cursor:pointer; padding:2px 6px;
}
.more-events:hover { text-decoration:underline; }

/* LEGEND */
.legend {
  display:flex; flex-wrap:wrap; justify-content:center;
  gap:12px; padding:20px 24px; max-width:1400px; margin:0 auto;
}
.legend-item {
  display:flex; align-items:center; gap:6px;
  font-size:0.78rem; font-weight:500; color:var(--text2);
}
.legend-dot {
  width:12px; height:12px; border-radius:4px; flex-shrink:0;
}

/* MODAL */
.modal-overlay {
  position:fixed; inset:0; background:rgba(0,0,0,0.5);
  display:none; align-items:center; justify-content:center;
  z-index:1000; padding:20px; backdrop-filter:blur(4px);
}
.modal-overlay.active { display:flex; }
.modal {
  background:#fff; border-radius:20px; max-width:480px; width:100%;
  overflow:hidden; animation:modalIn 0.3s ease;
  box-shadow:0 25px 60px rgba(0,0,0,0.3);
}
@keyframes modalIn { from { opacity:0; transform:scale(0.9) translateY(20px); } }
.modal-banner {
  padding:24px; color:#fff; position:relative;
}
.modal-banner .cat-badge {
  display:inline-block; background:rgba(255,255,255,0.25);
  padding:4px 12px; border-radius:12px; font-size:0.75rem;
  font-weight:600; margin-bottom:12px; backdrop-filter:blur(4px);
}
.modal-banner h2 { font-size:1.4rem; font-weight:800; line-height:1.3; }
.modal-body { padding:24px; }
.modal-info {
  display:flex; align-items:center; gap:10px; padding:10px 0;
  border-bottom:1px solid var(--border); font-size:0.9rem;
}
.modal-info:last-child { border-bottom:none; }
.modal-info .icon { font-size:1.2rem; width:30px; text-align:center; }
.modal-info .label { color:var(--text2); font-size:0.8rem; }
.modal-info .value { font-weight:600; }
.modal-desc {
  margin-top:16px; padding:16px; background:#f8fafc;
  border-radius:12px; font-size:0.9rem; line-height:1.6; color:#475569;
}
.modal-close {
  position:absolute; top:16px; right:16px; width:36px; height:36px;
  border-radius:50%; border:none; background:rgba(255,255,255,0.2);
  color:#fff; font-size:1.2rem; cursor:pointer; display:flex;
  align-items:center; justify-content:center; transition:all 0.2s;
}
.modal-close:hover { background:rgba(255,255,255,0.4); transform:rotate(90deg); }

/* DAY EVENTS MODAL (when clicking +N more) */
.day-modal { max-height:80vh; overflow-y:auto; }
.day-modal-title { padding:20px 24px; font-weight:700; font-size:1.1rem; border-bottom:1px solid var(--border); }
.day-event-item {
  display:flex; align-items:center; gap:12px; padding:14px 24px;
  cursor:pointer; transition:background 0.15s; border-bottom:1px solid #f1f5f9;
}
.day-event-item:hover { background:#f8fafc; }
.day-event-dot { width:10px; height:10px; border-radius:3px; flex-shrink:0; }
.day-event-info h4 { font-size:0.9rem; font-weight:600; }
.day-event-info p { font-size:0.78rem; color:var(--text2); }

/* FOOTER */
.footer {
  text-align:center; padding:20px; font-size:0.75rem; color:var(--text2);
  border-top:1px solid var(--border); margin-top:20px;
}

/* NO EVENTS */
.no-events {
  text-align:center; padding:60px 24px; color:var(--text2);
}
.no-events .icon { font-size:3rem; margin-bottom:12px; }

/* ADMIN IN PAGE */
.admin-login { max-width:380px; }
.admin-login-body { padding:24px; }
.admin-login-body h3 { font-size:1.1rem; margin-bottom:6px; }
.admin-login-body p { color:var(--text2); font-size:0.85rem; margin-bottom:14px; }
.admin-login-body input {
  width:100%; border:2px solid var(--border); border-radius:10px;
  padding:11px 12px; font-size:0.95rem; font-family:inherit;
}
.admin-login-body input:focus { outline:none; border-color:var(--today-bg); }
.admin-login-actions { display:flex; justify-content:flex-end; gap:8px; margin-top:12px; }
.admin-btn {
  border:none; border-radius:10px; cursor:pointer; font-family:inherit;
  font-weight:700; font-size:0.85rem; padding:10px 14px;
}
.admin-btn.secondary { background:#e2e8f0; color:#1e293b; }
.admin-btn.primary { background:var(--today-bg); color:#fff; }
.admin-login-error { color:#ef4444; font-size:0.8rem; margin-top:8px; display:none; }

.admin-app { max-width:1100px; width:100%; max-height:90vh; overflow:hidden; }
.admin-app-header {
  display:flex; align-items:center; justify-content:space-between;
  gap:8px; padding:16px 20px; border-bottom:1px solid var(--border);
}
.admin-app-header h2 { font-size:1.05rem; }
.admin-app-body {
  display:grid; grid-template-columns:340px 1fr; gap:14px;
  padding:14px; overflow:auto; max-height:calc(90vh - 70px);
}
@media(max-width:980px) { .admin-app-body { grid-template-columns:1fr; } }
.admin-card {
  border:1px solid var(--border); border-radius:12px; background:#fff; padding:12px;
}
.admin-card h3 { font-size:0.92rem; margin-bottom:10px; }
.admin-field { margin-bottom:10px; }
.admin-field label { display:block; font-size:0.78rem; color:var(--text2); margin-bottom:4px; }
.admin-field input, .admin-field select, .admin-field textarea {
  width:100%; border:2px solid var(--border); border-radius:10px;
  padding:9px 10px; font-size:0.87rem; font-family:inherit;
}
.admin-field input:focus, .admin-field select:focus, .admin-field textarea:focus {
  outline:none; border-color:var(--today-bg);
}
.admin-field textarea { min-height:72px; resize:vertical; }
.admin-two { display:grid; grid-template-columns:1fr 1fr; gap:8px; }
.admin-list { max-height:60vh; overflow:auto; }
.admin-item {
  border:1px solid var(--border); border-radius:10px; padding:10px;
  margin-bottom:8px; background:#f8fafc;
}
.admin-item h4 { font-size:0.88rem; margin-bottom:4px; }
.admin-meta { font-size:0.76rem; color:var(--text2); margin-bottom:8px; }
.admin-item-actions { display:flex; gap:6px; }
.admin-small {
  border:none; border-radius:8px; cursor:pointer; font-family:inherit;
  font-size:0.76rem; font-weight:700; padding:6px 10px;
}
.admin-small.edit { background:#dbeafe; color:#1d4ed8; }
.admin-small.del { background:#fee2e2; color:#dc2626; }
.admin-empty { color:var(--text2); font-size:0.85rem; padding:10px 2px; }
</style>
</head>
<body>

<div class="header">
  <button class="admin-entry" onclick="openAdminEntry()">Admin</button>
  <h1>üçΩÔ∏è Akcije & Promocije</h1>
  <p>Pregled svih akcija, promocija i evenata na≈°ih restorana</p>
</div>

<div class="filters" id="filters"></div>

<div class="nav-bar">
  <button class="nav-btn" onclick="navigate(-1)">‚óÄ</button>
  <button class="nav-today" onclick="goToday()">Danas</button>
  <button class="nav-btn" onclick="navigate(1)">‚ñ∂</button>
</div>

<div class="calendars" id="calendars"></div>

<div class="legend" id="legend"></div>

<div class="footer">
  Kalendar se redovno a≈æurira ‚Ä¢ Kliknite na dogaƒëaj za detalje
</div>

<!-- Event Detail Modal -->
<div class="modal-overlay" id="eventModal" onclick="closeModal(event)">
  <div class="modal" id="eventModalContent" onclick="event.stopPropagation()"></div>
</div>

<!-- Day Events Modal -->
<div class="modal-overlay" id="dayModal" onclick="closeModal(event)">
  <div class="modal day-modal" id="dayModalContent" onclick="event.stopPropagation()"></div>
</div>

<!-- Admin Login Modal -->
<div class="modal-overlay" id="adminLoginModal" onclick="closeModal(event)">
  <div class="modal admin-login" onclick="event.stopPropagation()">
    <div class="admin-login-body">
      <h3>Admin prijava</h3>
      <p>Unesite lozinku za upravljanje dogadjajima.</p>
      <input type="password" id="adminLoginPassword" placeholder="Lozinka" onkeypress="if(event.key==='Enter')submitAdminLogin()">
      <div class="admin-login-error" id="adminLoginError">Pogresna lozinka.</div>
      <div class="admin-login-actions">
        <button class="admin-btn secondary" onclick="closeAllModals()">Zatvori</button>
        <button class="admin-btn primary" onclick="submitAdminLogin()">Prijavi se</button>
      </div>
    </div>
  </div>
</div>

<!-- Admin Panel Modal -->
<div class="modal-overlay" id="adminPanelModal" onclick="closeModal(event)">
  <div class="modal admin-app" onclick="event.stopPropagation()">
    <div class="admin-app-header">
      <h2>Admin - Upravljanje dogadjajima</h2>
      <button class="admin-btn secondary" onclick="closeAllModals()">Zatvori</button>
    </div>
    <div class="admin-app-body">
      <div class="admin-card">
        <h3 id="adminFormTitle">Novi dogadjaj</h3>
        <input type="hidden" id="adminEventId">
        <div class="admin-field">
          <label>Naziv</label>
          <input type="text" id="adminEventTitle" placeholder="npr. Family bucket akcija">
        </div>
        <div class="admin-two">
          <div class="admin-field">
            <label>Restoran</label>
            <select id="adminEventRestaurant"></select>
          </div>
          <div class="admin-field">
            <label>Kategorija</label>
            <select id="adminEventCategory"></select>
          </div>
        </div>
        <div class="admin-two">
          <div class="admin-field">
            <label>Od</label>
            <input type="date" id="adminEventStart">
          </div>
          <div class="admin-field">
            <label>Do</label>
            <input type="date" id="adminEventEnd">
          </div>
        </div>
        <div class="admin-field">
          <label>Opis</label>
          <textarea id="adminEventDesc" placeholder="Detalji promocije..."></textarea>
        </div>
        <div class="admin-login-actions">
          <button class="admin-btn secondary" onclick="resetAdminForm()">Novo</button>
          <button class="admin-btn primary" onclick="saveAdminEvent()">Spremi</button>
        </div>
      </div>
      <div class="admin-card">
        <h3>Svi dogadjaji</h3>
        <div class="admin-list" id="adminEventsList"></div>
      </div>
    </div>
  </div>
</div>

<script src="app-config.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
<script>
// ============================================================
// KONFIGURACIJA ‚Äî Uredi prema svojim potrebama
// ============================================================
const CONFIG = {
  businessName: 'Na≈°i Restorani',
  
  restaurants: {
    'all':  'Svi restorani',
    'r1':   'KFC BCC',
    'r2':   'KFC SCC',
    'r3':   'KFC MCC',
    'r4':   'KFC STM',
    'r5':   'KFC ICC'
  },
  
  categories: {
    'akcija':     { label:'Akcija',         color:'#ef4444', icon:'üè∑Ô∏è' },
    'promocija':  { label:'Promocija',      color:'#22c55e', icon:'üì¢' },
    'happy_hour': { label:'Happy Hour',     color:'#3b82f6', icon:'üç∫' },
    'event':      { label:'Event',          color:'#f97316', icon:'üéâ' },
    'novo_meni':  { label:'Novo u meniju',  color:'#a855f7', icon:'üÜï' },
    'praznik':    { label:'Praznik',        color:'#eab308', icon:'üéä' },
    'rodjendan':  { label:'Roƒëendan',       color:'#ec4899', icon:'üéÇ' },
    'posebna':    { label:'Posebna ponuda', color:'#6366f1', icon:'‚≠ê' }
  }
};

// ============================================================
// FIREBASE KONFIGURACIJA (uzima iz app-config.js)
// ============================================================
const firebaseConfig = (window.APP_CONFIG && window.APP_CONFIG.firebase) ? window.APP_CONFIG.firebase : {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_PROJECT.firebaseapp.com",
  projectId: "YOUR_PROJECT_ID",
  storageBucket: "YOUR_PROJECT.appspot.com",
  messagingSenderId: "YOUR_SENDER_ID",
  appId: "YOUR_APP_ID"
};

// ============================================================
// DATA LAYER ‚Äî automatski koristi Firebase ili localStorage
// ============================================================
const USE_FIREBASE = firebaseConfig.apiKey !== 'YOUR_API_KEY';
let db = null;

const DataStore = {
  async getEvents() {
    if (USE_FIREBASE && db) {
      try {
        const snap = await db.collection('events').orderBy('startDate').get();
        return snap.docs.map(d => ({ id: d.id, ...d.data() }));
      } catch (err) {
        console.error('Firestore getEvents error:', err);
      }
    }
    return JSON.parse(localStorage.getItem('cal_events') || '[]');
  },
  async upsertEvent(eventData) {
    if (USE_FIREBASE && db) {
      await db.collection('events').doc(eventData.id).set(eventData);
      return;
    }
    const events = JSON.parse(localStorage.getItem('cal_events') || '[]');
    const idx = events.findIndex(e => e.id === eventData.id);
    if (idx >= 0) events[idx] = eventData; else events.push(eventData);
    localStorage.setItem('cal_events', JSON.stringify(events));
    notifyLocalEventsChanged();
  },
  async deleteEvent(eventId) {
    if (USE_FIREBASE && db) {
      await db.collection('events').doc(eventId).delete();
      return;
    }
    const events = JSON.parse(localStorage.getItem('cal_events') || '[]')
      .filter(e => e.id !== eventId);
    localStorage.setItem('cal_events', JSON.stringify(events));
    notifyLocalEventsChanged();
  }
};

// ============================================================
// STATE
// ============================================================
let allEvents = [];
let filteredEvents = [];
let activeFilter = 'all';
let centerDate = new Date();
let syncChannel = null;
let unsubEvents = null;
const DEFAULT_ADMIN_PASS = 'admin123';

const MONTH_NAMES = ['Januar','Februar','Mart','April','Maj','Juni',
                     'Juli','August','Septembar','Oktobar','Novembar','Decembar'];
const DAY_NAMES = ['Pon','Uto','Sri','ƒået','Pet','Sub','Ned'];

// ============================================================
// DEMO DATA ‚Äî bri≈°e se kad pove≈æete Firebase
// ============================================================
function initDemoData() {
  const existing = localStorage.getItem('cal_events');
  if (existing) return;
  
  const now = new Date();
  const y = now.getFullYear();
  const m = now.getMonth();
  
  const demo = [
    { id:'d1', title:'Pizza 2+1 GRATIS', restaurant:'all', category:'akcija',
      startDate:fmt(y,m,3), endDate:fmt(y,m,6),
      description:'Naruƒçi 2 pizze po izboru i treƒáa je potpuno BESPLATNA! Va≈æi za sve pizze iz menija. Ne propustite!' },
    { id:'d2', title:'Happy Hour -30%', restaurant:'r1', category:'happy_hour',
      startDate:fmt(y,m,8), endDate:fmt(y,m,8),
      description:'Sva piƒáa sa 30% popusta od 16:00 do 19:00. Kokteli, piva, vina ‚Äî sve po sni≈æenoj cijeni!' },
    { id:'d3', title:'Novi ljetni meni', restaurant:'r2', category:'novo_meni',
      startDate:fmt(y,m,10), endDate:fmt(y,m,15),
      description:'Predstavljamo novi ljetni meni sa svje≈æim salatama, grilovanim specialitetima i osvje≈æavajuƒáim desertima.' },
    { id:'d4', title:'Live muzika - Jazz Veƒçe', restaurant:'r3', category:'event',
      startDate:fmt(y,m,14), endDate:fmt(y,m,14),
      description:'U≈æivajte uz ≈æivu jazz muziku od 20:00. Nastupa Jazz Quartet Sarajevo. Rezervacije na 033/123-456.' },
    { id:'d5', title:'Dan restorana -50%', restaurant:'r1', category:'rodjendan',
      startDate:fmt(y,m,20), endDate:fmt(y,m,20),
      description:'Slavimo 5. roƒëendan Restorana Centar! Svi glavni obroci sa 50% popusta. Torta za sve goste!' },
    { id:'d6', title:'Burger Fest', restaurant:'all', category:'promocija',
      startDate:fmt(y,m,17), endDate:fmt(y,m,22),
      description:'Sedmica burgera! Svaki dan novi posebni burger po promotivnoj cijeni od 9.90 KM.' },
    { id:'d7', title:'Djeƒçiji kutak BESPLATNO', restaurant:'r4', category:'posebna',
      startDate:fmt(y,m,12), endDate:fmt(y,m,13),
      description:'Vikend za porodice! Besplatan djeƒçiji kutak sa animatorima od 11:00 do 15:00.' },
    { id:'d8', title:'Ramazanski meni', restaurant:'all', category:'posebna',
      startDate:fmt(y,m+1,1), endDate:fmt(y,m+1,10),
      description:'Poseban iftar meni sa 3 slijeda za samo 15 KM. Dostupno u svim restoranima.' },
    { id:'d9', title:'Wine & Dine veƒçer', restaurant:'r5', category:'event',
      startDate:fmt(y,m+1,5), endDate:fmt(y,m+1,5),
      description:'Degustacija vina uz 5-sljedni meni. Cijena: 45 KM/osobi. Broj mjesta ograniƒçen!' },
    { id:'d10', title:'ƒÜevapi vikend -20%', restaurant:'r2', category:'akcija',
      startDate:fmt(y,m,-3), endDate:fmt(y,m,-1),
      description:'Svi ƒáevapi sa 20% popusta! Sud≈æuke, pljeskavice i ƒáevapi. Va≈æi samo za vikend.' },
    { id:'d11', title:'Praznik rada', restaurant:'all', category:'praznik',
      startDate:fmt(y,m,1), endDate:fmt(y,m,1),
      description:'Sretan Praznik rada! Radno vrijeme: 10:00 - 22:00 u svim restoranima.' },
  ];
  localStorage.setItem('cal_events', JSON.stringify(demo));
}

function fmt(y, m, d) {
  const date = new Date(y, m, d);
  return date.toISOString().split('T')[0];
}

// ============================================================
// INIT
// ============================================================
async function init() {
  // Render static UI immediately so page is never blank on first load.
  renderFilters();
  renderLegend();
  renderCalendars();
  setupRealtimeSync();
  initAdminUi();
  
  try {
    if (USE_FIREBASE) {
      if (!firebase.apps || !firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
      }
      db = firebase.firestore();
    } else {
      initDemoData();
    }

    allEvents = await DataStore.getEvents();
    filteredEvents = [...allEvents];
    renderCalendars();
    renderAdminEvents();

    if (USE_FIREBASE) {
      startCloudSync();
    } else {
      // Safety poll in local mode
      setInterval(async () => {
        allEvents = await DataStore.getEvents();
        applyFilter();
      }, 60000);
    }
  } catch (err) {
    console.error('Calendar init error:', err);
    // Keep app usable even if cloud init fails.
    allEvents = JSON.parse(localStorage.getItem('cal_events') || '[]');
    filteredEvents = [...allEvents];
    renderCalendars();
    renderAdminEvents();
  }
}

function notifyLocalEventsChanged() {
  localStorage.setItem('cal_events_updated_at', new Date().toISOString());
  try {
    const ch = new BroadcastChannel('calendar_sync');
    ch.postMessage({ type: 'events_updated' });
    ch.close();
  } catch (_) {}
}

function setupRealtimeSync() {
  // Realtime between tabs/windows on the same origin.
  if (!USE_FIREBASE) {
    window.addEventListener('storage', async (e) => {
      if (e.key === 'cal_events' || e.key === 'cal_events_updated_at') {
        allEvents = await DataStore.getEvents();
        applyFilter();
      }
    });
    try {
      syncChannel = new BroadcastChannel('calendar_sync');
      syncChannel.onmessage = async (e) => {
        if (e.data && e.data.type === 'events_updated') {
          allEvents = await DataStore.getEvents();
          applyFilter();
        }
      };
    } catch (_) {}
  }
}

function startCloudSync() {
  if (!db) return;
  if (unsubEvents) unsubEvents();
  unsubEvents = db.collection('events').orderBy('startDate')
    .onSnapshot((snap) => {
      allEvents = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      applyFilter();
    }, (err) => {
      console.error('Firestore sync error:', err);
    });
}

// ============================================================
// FILTERS
// ============================================================
function renderFilters() {
  const container = document.getElementById('filters');
  container.innerHTML = Object.entries(CONFIG.restaurants).map(([key, name]) =>
    `<button class="filter-btn ${key === activeFilter ? 'active' : ''}" 
            onclick="setFilter('${key}')">${key === 'all' ? 'üçΩÔ∏è ' : 'üìç '}${name}</button>`
  ).join('');
}

function setFilter(restaurant) {
  activeFilter = restaurant;
  applyFilter();
  renderFilters();
}

function applyFilter() {
  filteredEvents = activeFilter === 'all' 
    ? [...allEvents]
    : allEvents.filter(e => e.restaurant === activeFilter || e.restaurant === 'all');
  renderCalendars();
  renderAdminEvents();
}

// ============================================================
// LEGEND
// ============================================================
function renderLegend() {
  document.getElementById('legend').innerHTML = Object.entries(CONFIG.categories).map(([key, cat]) =>
    `<div class="legend-item">
      <div class="legend-dot" style="background:${cat.color}"></div>
      ${cat.icon} ${cat.label}
    </div>`
  ).join('');
}

// ============================================================
// CALENDAR RENDERING
// ============================================================
function navigate(dir) {
  centerDate.setMonth(centerDate.getMonth() + dir);
  renderCalendars();
}

function goToday() {
  centerDate = new Date();
  renderCalendars();
}

function renderCalendars() {
  const container = document.getElementById('calendars');
  const cy = centerDate.getFullYear();
  const cm = centerDate.getMonth();
  
  const months = [
    { y: cm === 0 ? cy-1 : cy, m: cm === 0 ? 11 : cm-1, pos: 'left' },
    { y: cy, m: cm, pos: 'center' },
    { y: cm === 11 ? cy+1 : cy, m: cm === 11 ? 0 : cm+1, pos: 'right' }
  ];
  
  container.innerHTML = months.map(({ y, m, pos }) => renderMonth(y, m, pos)).join('');
}

function renderMonth(year, month, position) {
  const firstDay = new Date(year, month, 1);
  const daysInMonth = new Date(year, month + 1, 0).getDate();
  const prevMonthDays = new Date(year, month, 0).getDate();
  
  let startDow = firstDay.getDay() - 1;
  if (startDow < 0) startDow = 6;
  
  const today = new Date();
  const isCenter = position === 'center';
  
  let cells = '';
  
  // Previous month days
  for (let i = startDow - 1; i >= 0; i--) {
    const d = prevMonthDays - i;
    const pm = month === 0 ? 11 : month - 1;
    const py = month === 0 ? year - 1 : year;
    cells += renderDayCell(py, pm, d, false, today);
  }
  
  // Current month days
  for (let d = 1; d <= daysInMonth; d++) {
    cells += renderDayCell(year, month, d, true, today);
  }
  
  // Next month padding
  const totalCells = startDow + daysInMonth;
  const rows = Math.ceil(totalCells / 7);
  const remaining = (rows * 7) - totalCells;
  const nm = month === 11 ? 0 : month + 1;
  const ny = month === 11 ? year + 1 : year;
  for (let d = 1; d <= remaining; d++) {
    cells += renderDayCell(ny, nm, d, false, today);
  }
  
  return `
    <div class="month-card ${isCenter ? 'center' : ''}">
      <div class="month-header">${MONTH_NAMES[month]} ${year}</div>
      <div class="day-names">
        ${DAY_NAMES.map(d => `<div class="day-name">${d}</div>`).join('')}
      </div>
      <div class="days-grid">${cells}</div>
    </div>`;
}

function renderDayCell(year, month, day, isCurrentMonth, today) {
  const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
  const isToday = day === today.getDate() && month === today.getMonth() && year === today.getFullYear();
  const dayEvents = getEventsForDate(dateStr);
  
  const classes = [
    'day-cell',
    !isCurrentMonth ? 'other-month' : '',
    isToday ? 'today' : ''
  ].filter(Boolean).join(' ');
  
  const MAX_VISIBLE = 2;
  
  let eventsHtml = dayEvents.slice(0, MAX_VISIBLE).map(ev => {
    const cat = CONFIG.categories[ev.category] || CONFIG.categories.posebna;
    return `<div class="event-pill" style="background:${cat.color}" 
                 onclick="showEventDetail('${ev.id}')" title="${ev.title}">
              ${cat.icon} ${ev.title}
            </div>`;
  }).join('');
  
  if (dayEvents.length > MAX_VISIBLE) {
    eventsHtml += `<div class="more-events" onclick="showDayEvents('${dateStr}')">
                     +${dayEvents.length - MAX_VISIBLE} vi≈°e
                   </div>`;
  }
  
  return `<div class="${classes}">
    <span class="day-number">${isCurrentMonth ? day : day}</span>
    ${isCurrentMonth ? eventsHtml : ''}
  </div>`;
}

function getEventsForDate(dateStr) {
  return filteredEvents.filter(ev => dateStr >= ev.startDate && dateStr <= ev.endDate);
}

// ============================================================
// ADMIN (single-page mode)
// ============================================================
function getAdminPassword() {
  return localStorage.getItem('admin_pass') || DEFAULT_ADMIN_PASS;
}

function initAdminUi() {
  const rest = document.getElementById('adminEventRestaurant');
  const cat = document.getElementById('adminEventCategory');
  if (!rest || !cat) return;
  rest.innerHTML = Object.entries(CONFIG.restaurants).map(([k, v]) =>
    `<option value="${k}">${v}</option>`
  ).join('');
  cat.innerHTML = Object.entries(CONFIG.categories).map(([k, v]) =>
    `<option value="${k}">${v.label}</option>`
  ).join('');
  resetAdminForm();
}

function openAdminEntry() {
  const logged = sessionStorage.getItem('calendar_admin_logged') === 'true';
  if (logged) {
    openAdminPanel();
    return;
  }
  document.getElementById('adminLoginError').style.display = 'none';
  document.getElementById('adminLoginPassword').value = '';
  document.getElementById('adminLoginModal').classList.add('active');
  document.body.style.overflow = 'hidden';
}

function submitAdminLogin() {
  const input = document.getElementById('adminLoginPassword').value;
  if (input !== getAdminPassword()) {
    document.getElementById('adminLoginError').style.display = 'block';
    return;
  }
  sessionStorage.setItem('calendar_admin_logged', 'true');
  document.getElementById('adminLoginModal').classList.remove('active');
  openAdminPanel();
}

function openAdminPanel() {
  renderAdminEvents();
  document.getElementById('adminPanelModal').classList.add('active');
  document.body.style.overflow = 'hidden';
}

function resetAdminForm() {
  document.getElementById('adminFormTitle').textContent = 'Novi dogadjaj';
  document.getElementById('adminEventId').value = '';
  document.getElementById('adminEventTitle').value = '';
  document.getElementById('adminEventRestaurant').value = 'all';
  document.getElementById('adminEventCategory').value = 'akcija';
  document.getElementById('adminEventStart').value = '';
  document.getElementById('adminEventEnd').value = '';
  document.getElementById('adminEventDesc').value = '';
}

function editAdminEvent(eventId) {
  const ev = allEvents.find(e => e.id === eventId);
  if (!ev) return;
  document.getElementById('adminFormTitle').textContent = 'Uredi dogadjaj';
  document.getElementById('adminEventId').value = ev.id || '';
  document.getElementById('adminEventTitle').value = ev.title || '';
  document.getElementById('adminEventRestaurant').value = ev.restaurant || 'all';
  document.getElementById('adminEventCategory').value = ev.category || 'akcija';
  document.getElementById('adminEventStart').value = ev.startDate || '';
  document.getElementById('adminEventEnd').value = ev.endDate || '';
  document.getElementById('adminEventDesc').value = ev.description || '';
}

async function saveAdminEvent() {
  const title = document.getElementById('adminEventTitle').value.trim();
  const startDate = document.getElementById('adminEventStart').value;
  const endDate = document.getElementById('adminEventEnd').value;
  if (!title || !startDate || !endDate) {
    alert('Naziv, datum od i datum do su obavezni.');
    return;
  }
  if (endDate < startDate) {
    alert('Datum do ne moze biti prije datuma od.');
    return;
  }

  const id = document.getElementById('adminEventId').value || `evt_${Date.now()}`;
  const eventData = {
    id,
    title,
    restaurant: document.getElementById('adminEventRestaurant').value,
    category: document.getElementById('adminEventCategory').value,
    startDate,
    endDate,
    description: document.getElementById('adminEventDesc').value.trim(),
    updatedAt: new Date().toISOString()
  };

  try {
    await DataStore.upsertEvent(eventData);
    allEvents = await DataStore.getEvents();
    applyFilter();
    resetAdminForm();
  } catch (err) {
    console.error('Save event failed:', err);
    alert('Spremanje nije uspjelo. Provjerite Firestore/API postavke.');
  }
}

async function deleteAdminEvent(eventId) {
  if (!confirm('Obrisati ovaj dogadjaj?')) return;
  try {
    await DataStore.deleteEvent(eventId);
    allEvents = await DataStore.getEvents();
    applyFilter();
  } catch (err) {
    console.error('Delete event failed:', err);
    alert('Brisanje nije uspjelo. Provjerite Firestore/API postavke.');
  }
}

function renderAdminEvents() {
  const list = document.getElementById('adminEventsList');
  if (!list) return;

  const sorted = [...allEvents].sort((a, b) => b.startDate.localeCompare(a.startDate));
  if (!sorted.length) {
    list.innerHTML = '<div class="admin-empty">Nema dogadjaja.</div>';
    return;
  }

  list.innerHTML = sorted.map((ev) => {
    const cat = CONFIG.categories[ev.category] || CONFIG.categories.posebna;
    const rest = CONFIG.restaurants[ev.restaurant] || ev.restaurant || 'Svi restorani';
    return `<div class="admin-item">
      <h4>${ev.title}</h4>
      <div class="admin-meta">${cat.label} | ${rest} | ${formatDate(ev.startDate)} - ${formatDate(ev.endDate)}</div>
      <div class="admin-item-actions">
        <button class="admin-small edit" onclick="editAdminEvent('${ev.id}')">Uredi</button>
        <button class="admin-small del" onclick="deleteAdminEvent('${ev.id}')">Obrisi</button>
      </div>
    </div>`;
  }).join('');
}

// ============================================================
// MODALS
// ============================================================
function showEventDetail(eventId) {
  const ev = allEvents.find(e => e.id === eventId);
  if (!ev) return;
  
  const cat = CONFIG.categories[ev.category] || CONFIG.categories.posebna;
  const restName = ev.restaurant === 'all' ? 'Svi restorani' : (CONFIG.restaurants[ev.restaurant] || ev.restaurant);
  
  const startF = formatDate(ev.startDate);
  const endF = formatDate(ev.endDate);
  const dateDisplay = ev.startDate === ev.endDate ? startF : `${startF} ‚Äî ${endF}`;
  
  document.getElementById('eventModalContent').innerHTML = `
    <div class="modal-banner" style="background:${cat.color}">
      <button class="modal-close" onclick="closeAllModals()">‚úï</button>
      <div class="cat-badge">${cat.icon} ${cat.label}</div>
      <h2>${ev.title}</h2>
    </div>
    <div class="modal-body">
      <div class="modal-info">
        <span class="icon">üìç</span>
        <div><div class="label">Restoran</div><div class="value">${restName}</div></div>
      </div>
      <div class="modal-info">
        <span class="icon">üìÖ</span>
        <div><div class="label">Datum</div><div class="value">${dateDisplay}</div></div>
      </div>
      ${ev.description ? `<div class="modal-desc">${ev.description}</div>` : ''}
    </div>`;
  
  document.getElementById('eventModal').classList.add('active');
  document.body.style.overflow = 'hidden';
}

function showDayEvents(dateStr) {
  const dayEvents = getEventsForDate(dateStr);
  const d = formatDate(dateStr);
  
  document.getElementById('dayModalContent').innerHTML = `
    <div class="day-modal-title">üìÖ ${d}</div>
    ${dayEvents.map(ev => {
      const cat = CONFIG.categories[ev.category] || CONFIG.categories.posebna;
      return `<div class="day-event-item" onclick="closeAllModals();showEventDetail('${ev.id}')">
        <div class="day-event-dot" style="background:${cat.color}"></div>
        <div class="day-event-info">
          <h4>${cat.icon} ${ev.title}</h4>
          <p>${CONFIG.restaurants[ev.restaurant] || 'Svi restorani'}</p>
        </div>
      </div>`;
    }).join('')}`;
  
  document.getElementById('dayModal').classList.add('active');
  document.body.style.overflow = 'hidden';
}

function closeModal(e) {
  if (e.target.classList.contains('modal-overlay')) closeAllModals();
}
function closeAllModals() {
  document.querySelectorAll('.modal-overlay').forEach(m => m.classList.remove('active'));
  document.body.style.overflow = '';
}

function formatDate(dateStr) {
  const [y, m, d] = dateStr.split('-');
  return `${parseInt(d)}. ${MONTH_NAMES[parseInt(m)-1]} ${y}`;
}

// Keyboard close
document.addEventListener('keydown', e => { if (e.key === 'Escape') closeAllModals(); });

// Start
init();
</script>
</body>
</html>
