<!DOCTYPE html>
<html lang="hr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Akcije & Promocije | Na≈°i Restorani</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #f0f2f5;
  --card: #ffffff;
  --text: #1a1a2e;
  --text2: #64748b;
  --border: #e2e8f0;
  --today-bg: #3b82f6;
  --header-bg: linear-gradient(135deg, #1e293b 0%, #334155 100%);
  --akcija: #ef4444;
  --promocija: #22c55e;
  --happy_hour: #3b82f6;
  --event: #f97316;
  --novo_meni: #a855f7;
  --praznik: #eab308;
  --rodjendan: #ec4899;
  --posebna: #6366f1;
}
* { margin:0; padding:0; box-sizing:border-box; }
html, body { height:100%; }
body {
  font-family:'Inter',system-ui,sans-serif;
  background:var(--bg); color:var(--text);
  overflow:hidden;
  display:grid;
  grid-template-rows:auto auto auto minmax(0,1fr) auto;
}

/* HEADER */
.header {
  background:var(--header-bg); color:#fff; padding:8px 16px;
  text-align:center; position:relative; z-index:100;
  box-shadow:0 4px 20px rgba(0,0,0,0.15);
}
.header h1 { font-size:1.12rem; font-weight:800; letter-spacing:-0.4px; line-height:1.15; }
.header p { font-size:0.72rem; opacity:0.7; margin-top:1px; }
.admin-entry {
  position:absolute; right:16px; top:16px;
  border:1px solid rgba(255,255,255,0.35); color:#fff;
  background:rgba(255,255,255,0.12); backdrop-filter:blur(4px);
  border-radius:20px; padding:8px 14px; font-size:0.8rem;
  font-weight:700; cursor:pointer; font-family:inherit;
  z-index:3; pointer-events:auto;
}
.admin-entry:hover { background:rgba(255,255,255,0.2); }

/* FILTERS */
.filters {
  display:flex; gap:6px; padding:6px 10px; overflow-x:auto;
  background:#fff; border-bottom:1px solid var(--border);
  -webkit-overflow-scrolling:touch;
  flex:0 0 auto;
}
.filters::-webkit-scrollbar { display:none; }
.filter-btn {
  padding:6px 12px; border-radius:18px; border:2px solid var(--border);
  background:#fff; font-size:0.75rem; font-weight:700; cursor:pointer;
  white-space:nowrap; transition:all 0.2s; font-family:inherit;
}
.filter-btn:hover { border-color:var(--today-bg); color:var(--today-bg); }
.filter-btn.active {
  background:var(--today-bg); color:#fff; border-color:var(--today-bg);
}

/* NAVIGATION */
.nav-bar {
  display:flex; justify-content:center; align-items:center;
  gap:10px; padding:6px 12px;
  flex:0 0 auto;
}
.nav-btn {
  width:34px; height:34px; border-radius:50%; border:2px solid var(--border);
  background:#fff; cursor:pointer; font-size:1.1rem; display:flex;
  align-items:center; justify-content:center; transition:all 0.2s;
}
.nav-btn:hover { background:var(--today-bg); color:#fff; border-color:var(--today-bg); }
.nav-today {
  padding:6px 16px; border-radius:18px; border:2px solid var(--today-bg);
  background:#fff; color:var(--today-bg); font-weight:600; cursor:pointer;
  font-size:0.78rem; font-family:inherit; transition:all 0.2s;
}
.nav-today:hover { background:var(--today-bg); color:#fff; }
.nav-notice {
  width:clamp(190px, 23vw, 320px);
  display:flex;
  flex-direction:column;
  gap:4px;
}
.nav-line {
  border:1px solid #dbeafe;
  background:#eef2ff;
  color:#1e3a8a;
  border-radius:999px;
  padding:4px 10px;
  font-size:0.71rem;
  font-weight:700;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}
.nav-line.active {
  border-color:#bbf7d0;
  background:#ecfdf5;
  color:#166534;
}
.nav-line.upcoming {
  border-color:#c7d2fe;
  background:#eef2ff;
  color:#3730a3;
}
.nav-line.empty {
  border-color:#e2e8f0;
  background:#f8fafc;
  color:#64748b;
}
.nav-line.ghost {
  visibility:hidden;
}
@media(max-width:980px) {
  .nav-bar {
    flex-wrap:wrap;
    justify-content:center;
    column-gap:8px;
    row-gap:6px;
    padding:6px 8px 4px;
  }
  #navPrevBtn { order:1; }
  #navTodayBtn { order:2; }
  #navNextBtn { order:3; }
  #navActiveNotice { order:4; }
  #navNextNotice { order:5; }
  .nav-notice {
    width:auto;
    max-width:none;
    min-width:0;
    flex:1 1 calc(50% - 6px);
  }
  .nav-line {
    font-size:0.63rem;
    padding:3px 8px;
  }
}

/* CALENDAR CONTAINER */
.calendars {
  display:block;
  min-height:0; height:100%;
  padding:4px 8px 8px;
  max-width:1500px; width:100%; margin:0 auto;
}
@media(max-width:1024px) { .calendars { padding:6px 8px; } }

/* MONTH CARD */
.month-card {
  background:var(--card); border-radius:16px;
  box-shadow:0 1px 3px rgba(0,0,0,0.08); overflow:hidden;
  transition:box-shadow 0.2s;
  height:100%;
  display:grid;
  grid-template-rows:auto auto minmax(0,1fr);
}
.month-card:hover { box-shadow:0 8px 25px rgba(0,0,0,0.1); }
.month-card.center { box-shadow:0 4px 15px rgba(59,130,246,0.15); border:2px solid rgba(59,130,246,0.2); }
.month-header {
  padding:8px 16px; font-size:0.98rem; font-weight:800;
  text-align:center; border-bottom:1px solid var(--border);
}
.month-card.center .month-header {
  background:linear-gradient(135deg,#3b82f6,#6366f1); color:#fff;
}
.day-names {
  display:grid; grid-template-columns:repeat(7,1fr);
  padding:2px 6px 1px; gap:3px;
}
.day-name {
  text-align:center; font-size:0.58rem; font-weight:800;
  color:var(--text2); text-transform:uppercase; padding:4px;
}
.days-grid {
  display:grid; grid-template-columns:repeat(7,minmax(0,1fr));
  padding:0 6px 6px; gap:3px;
  min-height:0; height:100%;
}
.day-cell {
  min-height:0; height:auto; padding:3px; border-radius:8px;
  cursor:default; transition:background 0.15s; position:relative;
  overflow:hidden; border:1px solid #edf2f7;
  display:flex; flex-direction:column;
}
@media(max-width:1024px) { .day-cell { padding:2px; } }
.day-cell:hover { background:#f8fafc; }
.day-cell.empty { opacity:0.3; }
.day-cell.other-month .day-number { color:#cbd5e1; }
.day-number {
  font-size:0.72rem; font-weight:800; display:inline-flex;
  width:20px; height:20px; align-items:center; justify-content:center;
  border-radius:50%; margin-bottom:1px;
  flex:0 0 auto;
}
.day-cell.today .day-number {
  background:var(--today-bg); color:#fff;
  animation:pulse 2s infinite;
}
@keyframes pulse {
  0%,100% { box-shadow:0 0 0 0 rgba(59,130,246,0.4); }
  50% { box-shadow:0 0 0 6px rgba(59,130,246,0); }
}

/* EVENT PILLS */
.event-pill {
  font-size:0.63rem; font-weight:800; color:#fff;
  padding:0 6px; border-radius:6px; margin-bottom:0;
  white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
  cursor:pointer; transition:transform 0.15s, box-shadow 0.15s;
  line-height:1;
  display:flex; align-items:center; width:100%; max-width:100%;
  height:18px; min-height:18px;
}
.event-pill:hover { transform:scale(1.05); box-shadow:0 2px 8px rgba(0,0,0,0.2); z-index:10; position:relative; }
.day-events {
  display:grid;
  grid-template-rows:repeat(2, 18px);
  gap:2px;
  flex:0 0 auto;
  min-height:38px;
  overflow:hidden;
  padding-right:1px;
}
.more-events {
  font-size:0.64rem;
  color:var(--today-bg);
  font-weight:800;
  padding:0 6px;
  cursor:pointer;
  background:#eef2ff;
  border-radius:6px;
  border:1px solid #dbeafe;
  height:18px;
  min-height:18px;
  display:flex;
  align-items:center;
}
.more-events-popup {
  position:fixed;
  z-index:1200;
  min-width:220px;
  max-width:320px;
  background:#fff;
  border:1px solid var(--border);
  border-radius:12px;
  box-shadow:0 18px 42px rgba(0,0,0,0.18);
  overflow:hidden;
}
.more-events-popup-head {
  padding:10px 12px;
  background:#1e293b;
  color:#fff;
  font-size:0.8rem;
  font-weight:700;
}
.more-events-popup-list {
  max-height:280px;
  overflow-y:auto;
  padding:8px;
}
.more-events-popup-item {
  color:#fff;
  border-radius:7px;
  padding:7px 9px;
  font-size:0.78rem;
  font-weight:700;
  margin-bottom:6px;
  cursor:pointer;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}
.more-events:hover { text-decoration:underline; }
@media(max-width:768px) {
  .event-pill {
    height:18px;
    min-height:18px;
    font-size:0.62rem;
    padding:0 5px;
  }
  .more-events {
    display:block;
    width:100%;
    min-height:18px;
    height:18px;
    text-align:center;
    padding:0 5px;
    font-size:0.62rem;
  }
  .more-events-popup.mobile {
    width:calc(100vw - 24px);
    max-width:none;
    min-width:0;
    max-height:78vh;
    left:12px !important;
    top:50% !important;
    transform:translateY(-50%);
  }
  .more-events-popup.mobile .more-events-popup-list {
    max-height:calc(78vh - 44px);
  }
  .more-events-popup-item {
    min-height:36px;
    display:flex;
    align-items:center;
    font-size:0.86rem;
  }
}

/* LEGEND */
.legend {
  display:flex; flex-wrap:nowrap; justify-content:flex-start;
  gap:8px; padding:3px 8px; max-width:1500px; margin:0 auto;
  overflow-x:auto; flex:0 0 auto; width:100%;
}
.legend-item {
  display:flex; align-items:center; gap:6px;
  font-size:0.7rem; font-weight:600; color:var(--text2);
}
.legend-dot {
  width:12px; height:12px; border-radius:4px; flex-shrink:0;
}

/* MODAL */
.modal-overlay {
  position:fixed; inset:0; background:rgba(0,0,0,0.5);
  display:none; align-items:center; justify-content:center;
  z-index:1000; padding:20px; backdrop-filter:blur(4px);
}
.modal-overlay.active { display:flex; }
.modal {
  background:#fff; border-radius:20px; max-width:480px; width:100%;
  overflow:hidden; animation:modalIn 0.3s ease;
  box-shadow:0 25px 60px rgba(0,0,0,0.3);
}
@keyframes modalIn { from { opacity:0; transform:scale(0.9) translateY(20px); } }
.modal-banner {
  padding:24px; color:#fff; position:relative;
}
.modal-banner .cat-badge {
  display:inline-block; background:rgba(255,255,255,0.25);
  padding:4px 12px; border-radius:12px; font-size:0.75rem;
  font-weight:600; margin-bottom:12px; backdrop-filter:blur(4px);
}
.modal-banner h2 { font-size:1.4rem; font-weight:800; line-height:1.3; }
.modal-body { padding:24px; }
.modal-info {
  display:flex; align-items:center; gap:10px; padding:10px 0;
  border-bottom:1px solid var(--border); font-size:0.9rem;
}
.modal-info:last-child { border-bottom:none; }
.modal-info .icon { font-size:1.2rem; width:30px; text-align:center; }
.modal-info .label { color:var(--text2); font-size:0.8rem; }
.modal-info .value { font-weight:600; }
.modal-desc {
  margin-top:16px; padding:16px; background:#f8fafc;
  border-radius:12px; font-size:0.9rem; line-height:1.6; color:#475569;
}
.modal-attachment {
  margin-top:14px; border:1px solid var(--border);
  border-radius:12px; overflow:hidden; background:#eef2f7;
}
.modal-attachment img {
  display:block; width:100%; max-height:300px; object-fit:cover;
}
.modal-close {
  position:absolute; top:16px; right:16px; width:36px; height:36px;
  border-radius:50%; border:none; background:rgba(255,255,255,0.2);
  color:#fff; font-size:1.2rem; cursor:pointer; display:flex;
  align-items:center; justify-content:center; transition:all 0.2s;
}
.modal-close:hover { background:rgba(255,255,255,0.4); transform:rotate(90deg); }

/* DAY EVENTS MODAL (when clicking +N more) */
.day-modal { max-height:80vh; overflow-y:auto; }
.day-modal-title { padding:20px 24px; font-weight:700; font-size:1.1rem; border-bottom:1px solid var(--border); }
.day-event-item {
  display:flex; align-items:center; gap:12px; padding:14px 24px;
  cursor:pointer; transition:background 0.15s; border-bottom:1px solid #f1f5f9;
}
.day-event-item:hover { background:#f8fafc; }
.day-event-dot { width:10px; height:10px; border-radius:3px; flex-shrink:0; }
.day-event-info h4 { font-size:0.9rem; font-weight:600; }
.day-event-info p { font-size:0.78rem; color:var(--text2); }

/* FOOTER */
.footer {
  display:none;
}

/* NO EVENTS */
.no-events {
  text-align:center; padding:60px 24px; color:var(--text2);
}
.no-events .icon { font-size:3rem; margin-bottom:12px; }

/* ADMIN IN PAGE */
.admin-login { max-width:380px; }
.admin-login-body { padding:24px; }
.admin-login-body h3 { font-size:1.1rem; margin-bottom:6px; }
.admin-login-body p { color:var(--text2); font-size:0.85rem; margin-bottom:14px; }
.admin-login-body input {
  width:100%; border:2px solid var(--border); border-radius:10px;
  padding:11px 12px; font-size:0.95rem; font-family:inherit;
}
.admin-login-body input:focus { outline:none; border-color:var(--today-bg); }
.admin-login-actions { display:flex; justify-content:flex-end; gap:8px; margin-top:12px; }
.admin-btn {
  border:none; border-radius:10px; cursor:pointer; font-family:inherit;
  font-weight:700; font-size:0.85rem; padding:10px 14px;
}
.admin-btn.secondary { background:#e2e8f0; color:#1e293b; }
.admin-btn.primary { background:var(--today-bg); color:#fff; }
.admin-login-error { color:#ef4444; font-size:0.8rem; margin-top:8px; display:none; }

.admin-app { max-width:1100px; width:100%; max-height:90vh; overflow:hidden; }
.admin-app-header {
  display:flex; align-items:center; justify-content:space-between;
  gap:8px; padding:16px 20px; border-bottom:1px solid var(--border);
}
.admin-app-header h2 { font-size:1.05rem; }
.admin-app-body {
  display:grid; grid-template-columns:340px 1fr; gap:14px;
  padding:14px; overflow:auto; max-height:calc(90vh - 70px);
}
@media(max-width:980px) { .admin-app-body { grid-template-columns:1fr; } }
.admin-card {
  border:1px solid var(--border); border-radius:12px; background:#fff; padding:12px;
}
.admin-card h3 { font-size:0.92rem; margin-bottom:10px; }
.admin-list-head {
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:8px;
  margin-bottom:10px;
}
.admin-list-head h3 { margin:0; }
.admin-search {
  width:240px;
  max-width:100%;
  border:2px solid var(--border);
  border-radius:10px;
  padding:8px 10px;
  font-size:0.82rem;
  font-family:inherit;
}
.admin-search:focus { outline:none; border-color:var(--today-bg); }
.admin-field { margin-bottom:10px; }
.admin-field label { display:block; font-size:0.78rem; color:var(--text2); margin-bottom:4px; }
.admin-field input, .admin-field select, .admin-field textarea {
  width:100%; border:2px solid var(--border); border-radius:10px;
  padding:9px 10px; font-size:0.87rem; font-family:inherit;
}
.admin-field input:focus, .admin-field select:focus, .admin-field textarea:focus {
  outline:none; border-color:var(--today-bg);
}
.admin-field textarea { min-height:72px; resize:vertical; }
.admin-dropzone {
  border:2px dashed #cbd5e1; border-radius:12px; padding:14px;
  text-align:center; background:#f8fafc; cursor:pointer;
}
.admin-dropzone.dragover {
  border-color:var(--today-bg); background:#eff6ff;
}
.admin-dropzone p {
  font-size:0.8rem; color:var(--text2); margin:0;
}
.admin-image-preview {
  width:100%; max-height:170px; object-fit:cover;
  border-radius:10px; display:none; margin-top:8px;
}
.admin-upload-actions {
  display:flex; justify-content:flex-end; margin-top:6px;
}
.admin-two { display:grid; grid-template-columns:1fr 1fr; gap:8px; }
.admin-list { max-height:60vh; overflow:auto; }
.admin-item {
  border:1px solid var(--border); border-radius:10px; padding:10px;
  margin-bottom:8px; background:#f8fafc;
}
.admin-item h4 { font-size:0.88rem; margin-bottom:4px; }
.admin-meta { font-size:0.76rem; color:var(--text2); margin-bottom:8px; }
.admin-item-actions { display:flex; gap:6px; }
.admin-small {
  border:none; border-radius:8px; cursor:pointer; font-family:inherit;
  font-size:0.76rem; font-weight:700; padding:6px 10px;
}
.admin-small.edit { background:#dbeafe; color:#1d4ed8; }
.admin-small.del { background:#fee2e2; color:#dc2626; }
.admin-empty { color:var(--text2); font-size:0.85rem; padding:10px 2px; }
</style>
</head>
<body>

<div class="header">
  <button class="admin-entry" onclick="openAdminEntry()">Admin</button>
  <h1>üçΩÔ∏è Akcije & Promocije</h1>
  <p>Pregled svih akcija, promocija i evenata na≈°ih restorana</p>
</div>

<div class="filters" id="filters"></div>

<div class="nav-bar">
  <button class="nav-btn" id="navPrevBtn" onclick="navigate(-1)">&#9664;</button>
  <div class="nav-notice" id="navActiveNotice">
    <div class="nav-line empty">Aktivno: nema</div>
    <div class="nav-line ghost">&nbsp;</div>
  </div>
  <button class="nav-today" id="navTodayBtn" onclick="goToday()">Danas</button>
  <div class="nav-notice" id="navNextNotice">
    <div class="nav-line empty">Nadolazeci: nema</div>
    <div class="nav-line ghost">&nbsp;</div>
  </div>
  <button class="nav-btn" id="navNextBtn" onclick="navigate(1)">&#9654;</button>
</div>

<div class="calendars" id="calendars"></div>

<div class="legend" id="legend"></div>

<div class="footer">
  Kalendar se redovno a≈æurira ‚Ä¢ Kliknite na dogaƒëaj za detalje
</div>

<!-- Event Detail Modal -->
<div class="modal-overlay" id="eventModal" onclick="closeModal(event)">
  <div class="modal" id="eventModalContent" onclick="event.stopPropagation()"></div>
</div>

<!-- Day Events Modal -->
<div class="modal-overlay" id="dayModal" onclick="closeModal(event)">
  <div class="modal day-modal" id="dayModalContent" onclick="event.stopPropagation()"></div>
</div>

<!-- Admin Login Modal -->
<div class="modal-overlay" id="adminLoginModal" onclick="closeModal(event)">
  <div class="modal admin-login" onclick="event.stopPropagation()">
    <div class="admin-login-body">
      <h3>Admin prijava</h3>
      <p>Unesite lozinku za upravljanje dogadjajima.</p>
      <input type="password" id="adminLoginPassword" placeholder="Lozinka" onkeypress="if(event.key==='Enter')submitAdminLogin()">
      <div class="admin-login-error" id="adminLoginError">Pogresna lozinka.</div>
      <div class="admin-login-actions">
        <button class="admin-btn secondary" onclick="closeAllModals()">Zatvori</button>
        <button class="admin-btn primary" onclick="submitAdminLogin()">Prijavi se</button>
      </div>
    </div>
  </div>
</div>

<!-- Admin Panel Modal -->
<div class="modal-overlay" id="adminPanelModal" onclick="closeModal(event)">
  <div class="modal admin-app" onclick="event.stopPropagation()">
    <div class="admin-app-header">
      <h2>Admin - Upravljanje dogadjajima</h2>
      <button class="admin-btn secondary" onclick="closeAllModals()">Zatvori</button>
    </div>
    <div class="admin-app-body">
      <div class="admin-card">
        <h3 id="adminFormTitle">Novi dogadjaj</h3>
        <input type="hidden" id="adminEventId">
        <div class="admin-field">
          <label>Naziv</label>
          <input type="text" id="adminEventTitle" placeholder="npr. Family bucket akcija">
        </div>
        <div class="admin-two">
          <div class="admin-field">
            <label>Restoran</label>
            <select id="adminEventRestaurant"></select>
          </div>
          <div class="admin-field">
            <label>Kategorija</label>
            <select id="adminEventCategory"></select>
          </div>
        </div>
        <div class="admin-two">
          <div class="admin-field">
            <label>Od</label>
            <input type="date" id="adminEventStart">
          </div>
          <div class="admin-field">
            <label>Do</label>
            <input type="date" id="adminEventEnd">
          </div>
        </div>
        <div class="admin-field">
          <label>Opis</label>
          <textarea id="adminEventDesc" placeholder="Detalji promocije..."></textarea>
        </div>
        <div class="admin-field">
          <label>Slika (attachment)</label>
          <div class="admin-dropzone" id="adminDropzone">
            <p id="adminDropHint">Prevuci sliku ovdje ili klikni za upload.</p>
            <input type="file" id="adminImageInput" accept="image/*" style="display:none">
            <img id="adminImagePreview" class="admin-image-preview" alt="Pregled slike">
          </div>
          <div class="admin-upload-actions">
            <button class="admin-small del" type="button" onclick="removeAdminImage()">Ukloni sliku</button>
          </div>
        </div>
        <div class="admin-login-actions">
          <button class="admin-btn secondary" onclick="resetAdminForm()">Novo</button>
          <button class="admin-btn primary" onclick="saveAdminEvent()">Spremi</button>
        </div>
      </div>
      <div class="admin-card">
        <div class="admin-list-head">
          <h3>Svi dogadjaji</h3>
          <input class="admin-search" id="adminSearchInput" type="text" placeholder="Pretraga (naziv, restoran, kategorija...)" oninput="setAdminSearchTerm(this.value)">
        </div>
        <div class="admin-list" id="adminEventsList"></div>
      </div>
    </div>
  </div>
</div>

<script src="app-config.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
<script>
// ============================================================
// KONFIGURACIJA ‚Äî Uredi prema svojim potrebama
// ============================================================
const CONFIG = {
  businessName: 'Na≈°i Restorani',
  
  restaurants: {
    'all':  'Svi restorani',
    'r1':   'KFC BCC',
    'r2':   'KFC SCC',
    'r3':   'KFC MCC',
    'r4':   'KFC STM',
    'r5':   'KFC ICC'
  },
  
  categories: {
    'akcija':     { label:'Akcija',         color:'#ef4444', icon:'üè∑Ô∏è' },
    'promocija':  { label:'Promocija',      color:'#22c55e', icon:'üì¢' },
    'happy_hour': { label:'Happy Hour',     color:'#3b82f6', icon:'üç∫' },
    'event':      { label:'Event',          color:'#f97316', icon:'üéâ' },
    'novo_meni':  { label:'Novo u meniju',  color:'#a855f7', icon:'üÜï' },
    'praznik':    { label:'Praznik',        color:'#eab308', icon:'üéä' },
    'rodjendan':  { label:'Roƒëendan',       color:'#ec4899', icon:'üéÇ' },
    'posebna':    { label:'Posebna ponuda', color:'#6366f1', icon:'‚≠ê' }
  }
};

// ============================================================
// FIREBASE KONFIGURACIJA (uzima iz app-config.js)
// ============================================================
const firebaseConfig = (window.APP_CONFIG && window.APP_CONFIG.firebase) ? window.APP_CONFIG.firebase : {
  apiKey: "AIzaSyBNHlonJCyQcjV2AMxqfYfnUrkq4bb7ut4",
  authDomain: "nea-marketing-app.firebaseapp.com",
  projectId: "nea-marketing-app",
  storageBucket: "nea-marketing-app.firebasestorage.app",
  messagingSenderId: "1075544125721",
  appId: "1:1075544125721:web:3393e1db30600795641588",
  measurementId: "G-EY1KXYMG5T"
};

// ============================================================
// DATA LAYER ‚Äî automatski koristi Firebase ili localStorage
// ============================================================
const USE_FIREBASE = !!firebaseConfig.apiKey;
let db = null;

const DataStore = {
  async getEvents() {
    if (USE_FIREBASE && db) {
      try {
        const snap = await db.collection('events').orderBy('startDate').get();
        return snap.docs.map(d => ({ id: d.id, ...d.data() }));
      } catch (err) {
        console.error('Firestore getEvents error:', err);
      }
    }
    return JSON.parse(localStorage.getItem('cal_events') || '[]');
  },
  async upsertEvent(eventData) {
    if (USE_FIREBASE && db) {
      await db.collection('events').doc(eventData.id).set(eventData);
      return;
    }
    const events = JSON.parse(localStorage.getItem('cal_events') || '[]');
    const idx = events.findIndex(e => e.id === eventData.id);
    if (idx >= 0) events[idx] = eventData; else events.push(eventData);
    localStorage.setItem('cal_events', JSON.stringify(events));
    notifyLocalEventsChanged();
  },
  async deleteEvent(eventId) {
    if (USE_FIREBASE && db) {
      await db.collection('events').doc(eventId).delete();
      return;
    }
    const events = JSON.parse(localStorage.getItem('cal_events') || '[]')
      .filter(e => e.id !== eventId);
    localStorage.setItem('cal_events', JSON.stringify(events));
    notifyLocalEventsChanged();
  }
};

// ============================================================
// STATE
// ============================================================
let allEvents = [];
let filteredEvents = [];
let activeFilter = 'all';
let centerDate = new Date();
let syncChannel = null;
let unsubEvents = null;
const DEFAULT_ADMIN_PASS = 'admin123';
let adminImageData = '';
let dayEventsPopupEl = null;
let adminSearchTerm = '';

const MONTH_NAMES = ['Januar','Februar','Mart','April','Maj','Juni',
                     'Juli','August','Septembar','Oktobar','Novembar','Decembar'];
const DAY_NAMES = ['Pon','Uto','Sri','ƒået','Pet','Sub','Ned'];

// ============================================================
// DEMO DATA ‚Äî bri≈°e se kad pove≈æete Firebase
// ============================================================
function initDemoData() {
  const existing = localStorage.getItem('cal_events');
  if (existing) return;
  
  const now = new Date();
  const y = now.getFullYear();
  const m = now.getMonth();
  
  const demo = [
    { id:'d1', title:'Pizza 2+1 GRATIS', restaurant:'all', category:'akcija',
      startDate:fmt(y,m,3), endDate:fmt(y,m,6),
      description:'Naruƒçi 2 pizze po izboru i treƒáa je potpuno BESPLATNA! Va≈æi za sve pizze iz menija. Ne propustite!' },
    { id:'d2', title:'Happy Hour -30%', restaurant:'r1', category:'happy_hour',
      startDate:fmt(y,m,8), endDate:fmt(y,m,8),
      description:'Sva piƒáa sa 30% popusta od 16:00 do 19:00. Kokteli, piva, vina ‚Äî sve po sni≈æenoj cijeni!' },
    { id:'d3', title:'Novi ljetni meni', restaurant:'r2', category:'novo_meni',
      startDate:fmt(y,m,10), endDate:fmt(y,m,15),
      description:'Predstavljamo novi ljetni meni sa svje≈æim salatama, grilovanim specialitetima i osvje≈æavajuƒáim desertima.' },
    { id:'d4', title:'Live muzika - Jazz Veƒçe', restaurant:'r3', category:'event',
      startDate:fmt(y,m,14), endDate:fmt(y,m,14),
      description:'U≈æivajte uz ≈æivu jazz muziku od 20:00. Nastupa Jazz Quartet Sarajevo. Rezervacije na 033/123-456.' },
    { id:'d5', title:'Dan restorana -50%', restaurant:'r1', category:'rodjendan',
      startDate:fmt(y,m,20), endDate:fmt(y,m,20),
      description:'Slavimo 5. roƒëendan Restorana Centar! Svi glavni obroci sa 50% popusta. Torta za sve goste!' },
    { id:'d6', title:'Burger Fest', restaurant:'all', category:'promocija',
      startDate:fmt(y,m,17), endDate:fmt(y,m,22),
      description:'Sedmica burgera! Svaki dan novi posebni burger po promotivnoj cijeni od 9.90 KM.' },
    { id:'d7', title:'Djeƒçiji kutak BESPLATNO', restaurant:'r4', category:'posebna',
      startDate:fmt(y,m,12), endDate:fmt(y,m,13),
      description:'Vikend za porodice! Besplatan djeƒçiji kutak sa animatorima od 11:00 do 15:00.' },
    { id:'d8', title:'Ramazanski meni', restaurant:'all', category:'posebna',
      startDate:fmt(y,m+1,1), endDate:fmt(y,m+1,10),
      description:'Poseban iftar meni sa 3 slijeda za samo 15 KM. Dostupno u svim restoranima.' },
    { id:'d9', title:'Wine & Dine veƒçer', restaurant:'r5', category:'event',
      startDate:fmt(y,m+1,5), endDate:fmt(y,m+1,5),
      description:'Degustacija vina uz 5-sljedni meni. Cijena: 45 KM/osobi. Broj mjesta ograniƒçen!' },
    { id:'d10', title:'ƒÜevapi vikend -20%', restaurant:'r2', category:'akcija',
      startDate:fmt(y,m,-3), endDate:fmt(y,m,-1),
      description:'Svi ƒáevapi sa 20% popusta! Sud≈æuke, pljeskavice i ƒáevapi. Va≈æi samo za vikend.' },
    { id:'d11', title:'Praznik rada', restaurant:'all', category:'praznik',
      startDate:fmt(y,m,1), endDate:fmt(y,m,1),
      description:'Sretan Praznik rada! Radno vrijeme: 10:00 - 22:00 u svim restoranima.' },
  ];
  localStorage.setItem('cal_events', JSON.stringify(demo));
}

function fmt(y, m, d) {
  const date = new Date(y, m, d);
  return date.toISOString().split('T')[0];
}

// ============================================================
// INIT
// ============================================================
async function init() {
  // Render static UI immediately so page is never blank on first load.
  renderFilters();
  renderLegend();
  renderCalendars();
  renderNextEventNotice();
  setupRealtimeSync();
  initAdminUi();
  
  try {
    if (USE_FIREBASE) {
      if (!firebase.apps || !firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
      }
      db = firebase.firestore();
    } else {
      initDemoData();
    }

    allEvents = await DataStore.getEvents();
    filteredEvents = [...allEvents];
    renderCalendars();
    renderAdminEvents();
    renderNextEventNotice();

    if (USE_FIREBASE) {
      startCloudSync();
    } else {
      // Safety poll in local mode
      setInterval(async () => {
        allEvents = await DataStore.getEvents();
        applyFilter();
      }, 60000);
    }
  } catch (err) {
    console.error('Calendar init error:', err);
    // Keep app usable even if cloud init fails.
    allEvents = JSON.parse(localStorage.getItem('cal_events') || '[]');
    filteredEvents = [...allEvents];
    renderCalendars();
    renderAdminEvents();
    renderNextEventNotice();
  }
}

function notifyLocalEventsChanged() {
  localStorage.setItem('cal_events_updated_at', new Date().toISOString());
  try {
    const ch = new BroadcastChannel('calendar_sync');
    ch.postMessage({ type: 'events_updated' });
    ch.close();
  } catch (_) {}
}

function setupRealtimeSync() {
  // Realtime between tabs/windows on the same origin.
  if (!USE_FIREBASE) {
    window.addEventListener('storage', async (e) => {
      if (e.key === 'cal_events' || e.key === 'cal_events_updated_at') {
        allEvents = await DataStore.getEvents();
        applyFilter();
      }
    });
    try {
      syncChannel = new BroadcastChannel('calendar_sync');
      syncChannel.onmessage = async (e) => {
        if (e.data && e.data.type === 'events_updated') {
          allEvents = await DataStore.getEvents();
          applyFilter();
        }
      };
    } catch (_) {}
  }
}

function startCloudSync() {
  if (!db) return;
  if (unsubEvents) unsubEvents();
  unsubEvents = db.collection('events').orderBy('startDate')
    .onSnapshot((snap) => {
      allEvents = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      applyFilter();
    }, (err) => {
      console.error('Firestore sync error:', err);
    });
}

// ============================================================
// FILTERS
// ============================================================
function renderFilters() {
  const container = document.getElementById('filters');
  container.innerHTML = Object.entries(CONFIG.restaurants).map(([key, name]) =>
    `<button class="filter-btn ${key === activeFilter ? 'active' : ''}" 
            onclick="setFilter('${key}')">${key === 'all' ? 'üçΩÔ∏è ' : 'üìç '}${name}</button>`
  ).join('');
}

function setFilter(restaurant) {
  activeFilter = restaurant;
  applyFilter();
  renderFilters();
}

function applyFilter() {
  filteredEvents = activeFilter === 'all' 
    ? [...allEvents]
    : allEvents.filter(e => e.restaurant === activeFilter || e.restaurant === 'all');
  renderCalendars();
  renderAdminEvents();
  renderNextEventNotice();
}

function dateStrToLocalDate(dateStr) {
  const parts = (dateStr || '').split('-').map(Number);
  if (parts.length !== 3 || !parts[0] || !parts[1] || !parts[2]) return null;
  return new Date(parts[0], parts[1] - 1, parts[2]);
}

function getTodayLocalDate() {
  const t = new Date();
  t.setHours(0, 0, 0, 0);
  return t;
}

function formatDaysUntil(daysUntil) {
  if (daysUntil <= 0) return 'danas';
  if (daysUntil === 1) return 'sutra';
  return `za ${daysUntil} dana`;
}

function renderNavNoticeLines(container, lines, tone, emptyFallback) {
  if (!container) return;
  const safeLines = (lines && lines.length ? lines : [emptyFallback]).slice(0, 2);
  while (safeLines.length < 2) safeLines.push('');
  container.innerHTML = '';
  safeLines.forEach((text) => {
    const row = document.createElement('div');
    const hasText = !!text;
    row.className = `nav-line ${hasText ? tone : 'ghost'}`;
    if (hasText) row.textContent = text;
    else row.innerHTML = '&nbsp;';
    container.appendChild(row);
  });
}

function renderNextEventNotice() {
  const activeEl = document.getElementById('navActiveNotice');
  const nextEl = document.getElementById('navNextNotice');
  if (!activeEl || !nextEl) return;

  const today = getTodayLocalDate();
  const todayStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;

  const activeNow = filteredEvents
    .filter((ev) => ev.startDate <= todayStr && ev.endDate >= todayStr)
    .sort((a, b) => a.endDate.localeCompare(b.endDate));

  if (activeNow.length) {
    const activeLines = activeNow.slice(0, 2).map((ev) => {
      const cat = CONFIG.categories[ev.category] || CONFIG.categories.posebna;
      return `Aktivno: ${cat.icon} ${ev.title}`;
    });
    if (activeNow.length > 2 && activeLines[1]) {
      activeLines[1] = `${activeLines[1]} +${activeNow.length - 2}`;
    }
    renderNavNoticeLines(activeEl, activeLines, 'active', 'Aktivno: nema');
  } else {
    renderNavNoticeLines(activeEl, ['Aktivno: nema'], 'empty', 'Aktivno: nema');
  }

  const nextEvent = filteredEvents
    .filter((ev) => ev.startDate > todayStr)
    .sort((a, b) => a.startDate.localeCompare(b.startDate));

  if (!nextEvent.length) {
    renderNavNoticeLines(nextEl, ['Nadolazeci: nema'], 'empty', 'Nadolazeci: nema');
    return;
  }

  const nextLines = nextEvent.slice(0, 2).map((ev) => {
    const nextDate = dateStrToLocalDate(ev.startDate);
    const daysUntil = nextDate ? Math.round((nextDate - today) / 86400000) : 0;
    const category = CONFIG.categories[ev.category] || CONFIG.categories.posebna;
    return `Nadolazeci ${formatDaysUntil(daysUntil)}: ${category.icon} ${ev.title}`;
  });
  if (nextEvent.length > 2 && nextLines[1]) {
    nextLines[1] = `${nextLines[1]} +${nextEvent.length - 2}`;
  }
  renderNavNoticeLines(nextEl, nextLines, 'upcoming', 'Nadolazeci: nema');
}

// ============================================================
// LEGEND
// ============================================================
function renderLegend() {
  document.getElementById('legend').innerHTML = Object.entries(CONFIG.categories).map(([key, cat]) =>
    `<div class="legend-item">
      <div class="legend-dot" style="background:${cat.color}"></div>
      ${cat.icon} ${cat.label}
    </div>`
  ).join('');
}

// ============================================================
// CALENDAR RENDERING
// ============================================================
function navigate(dir) {
  centerDate.setMonth(centerDate.getMonth() + dir);
  renderCalendars();
}

function goToday() {
  centerDate = new Date();
  renderCalendars();
}

function isCompactMobile() {
  return window.matchMedia('(max-width: 768px)').matches;
}

function renderCalendars() {
  hideDayEventsPopup();
  const container = document.getElementById('calendars');
  const cy = centerDate.getFullYear();
  const cm = centerDate.getMonth();
  container.innerHTML = renderMonth(cy, cm, 'center');
}

function renderMonth(year, month, position) {
  const firstDay = new Date(year, month, 1);
  const daysInMonth = new Date(year, month + 1, 0).getDate();
  const prevMonthDays = new Date(year, month, 0).getDate();
  
  let startDow = firstDay.getDay() - 1;
  if (startDow < 0) startDow = 6;
  
  const today = new Date();
  const isCenter = position === 'center';
  const totalCells = startDow + daysInMonth;
  const rows = Math.ceil(totalCells / 7);
  
  let cells = '';
  
  // Previous month days
  for (let i = startDow - 1; i >= 0; i--) {
    const d = prevMonthDays - i;
    const pm = month === 0 ? 11 : month - 1;
    const py = month === 0 ? year - 1 : year;
    cells += renderDayCell(py, pm, d, false, today);
  }
  
  // Current month days
  for (let d = 1; d <= daysInMonth; d++) {
    cells += renderDayCell(year, month, d, true, today);
  }
  
  // Next month padding
  const remaining = (rows * 7) - totalCells;
  const nm = month === 11 ? 0 : month + 1;
  const ny = month === 11 ? year + 1 : year;
  for (let d = 1; d <= remaining; d++) {
    cells += renderDayCell(ny, nm, d, false, today);
  }
  
  return `
    <div class="month-card ${isCenter ? 'center' : ''}">
      <div class="month-header">${MONTH_NAMES[month]} ${year}</div>
      <div class="day-names">
        ${DAY_NAMES.map(d => `<div class="day-name">${d}</div>`).join('')}
      </div>
      <div class="days-grid" style="grid-template-rows:repeat(${rows}, minmax(0,1fr));">${cells}</div>
    </div>`;
}

function renderDayCell(year, month, day, isCurrentMonth, today) {
  const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
  const isToday = day === today.getDate() && month === today.getMonth() && year === today.getFullYear();
  const dayEvents = getEventsForDate(dateStr);
  
  const classes = [
    'day-cell',
    !isCurrentMonth ? 'other-month' : '',
    isToday ? 'today' : ''
  ].filter(Boolean).join(' ');
  
  let eventsHtml = '';
  if (dayEvents.length <= 2) {
    eventsHtml = dayEvents.map((ev) => {
      const cat = CONFIG.categories[ev.category] || CONFIG.categories.posebna;
      return `<div class="event-pill" style="background:${cat.color}" 
                   onclick="showEventDetail('${ev.id}')" title="${ev.title}">
                ${cat.icon} ${ev.title}
              </div>`;
    }).join('');
  } else {
    const first = dayEvents[0];
    const cat = CONFIG.categories[first.category] || CONFIG.categories.posebna;
    eventsHtml = `<div class="event-pill" style="background:${cat.color}" 
                      onclick="showEventDetail('${first.id}')" title="${first.title}">
                   ${cat.icon} ${first.title}
                 </div>
                 <div class="more-events" onclick="showDayEventsPopup(event, '${dateStr}')">+${dayEvents.length - 1}</div>`;
  }

  return `<div class="${classes}">
    <span class="day-number">${day}</span>
    ${isCurrentMonth ? `<div class="day-events">${eventsHtml}</div>` : ''}
  </div>`;
}

function getEventCreatedScore(ev) {
  const created = parseDateToMs(ev.createdAt);
  if (!Number.isNaN(created)) return created;
  if (ev.id && /^evt_\d+$/.test(ev.id)) return Number(ev.id.slice(4));
  const updated = parseDateToMs(ev.updatedAt);
  if (!Number.isNaN(updated)) return updated;
  const start = parseDateToMs(ev.startDate);
  if (!Number.isNaN(start)) return start;
  return 0;
}

function getEventsForDate(dateStr) {
  return filteredEvents
    .filter(ev => dateStr >= ev.startDate && dateStr <= ev.endDate)
    .sort((a, b) => getEventCreatedScore(a) - getEventCreatedScore(b));
}

// ============================================================
// ADMIN (single-page mode)
// ============================================================
function getAdminPassword() {
  return localStorage.getItem('admin_pass') || DEFAULT_ADMIN_PASS;
}

function initAdminUi() {
  const rest = document.getElementById('adminEventRestaurant');
  const cat = document.getElementById('adminEventCategory');
  if (!rest || !cat) return;
  rest.innerHTML = Object.entries(CONFIG.restaurants).map(([k, v]) =>
    `<option value="${k}">${v}</option>`
  ).join('');
  cat.innerHTML = Object.entries(CONFIG.categories).map(([k, v]) =>
    `<option value="${k}">${v.label}</option>`
  ).join('');
  setupAdminUpload();
  resetAdminForm();
}

function openAdminEntry() {
  const logged = sessionStorage.getItem('calendar_admin_logged') === 'true';
  if (logged) {
    openAdminPanel();
    return;
  }
  const modal = document.getElementById('adminLoginModal');
  const errorEl = document.getElementById('adminLoginError');
  const passEl = document.getElementById('adminLoginPassword');
  if (modal && errorEl && passEl) {
    errorEl.style.display = 'none';
    passEl.value = '';
    modal.classList.add('active');
    document.body.style.overflow = 'hidden';
    return;
  }
  // Fallback if modal is unavailable.
  const input = prompt('Admin lozinka:');
  if (input === null) return;
  if (input !== getAdminPassword()) {
    alert('Pogresna lozinka.');
    return;
  }
  sessionStorage.setItem('calendar_admin_logged', 'true');
  openAdminPanel();
}

function submitAdminLogin() {
  const inputEl = document.getElementById('adminLoginPassword');
  const errEl = document.getElementById('adminLoginError');
  if (!inputEl || !errEl) {
    openAdminEntry();
    return;
  }
  const input = inputEl.value;
  if (input !== getAdminPassword()) {
    errEl.style.display = 'block';
    return;
  }
  sessionStorage.setItem('calendar_admin_logged', 'true');
  const modal = document.getElementById('adminLoginModal');
  if (modal) modal.classList.remove('active');
  openAdminPanel();
}

function openAdminPanel() {
  const searchEl = document.getElementById('adminSearchInput');
  if (searchEl) searchEl.value = adminSearchTerm;
  renderAdminEvents();
  document.getElementById('adminPanelModal').classList.add('active');
  document.body.style.overflow = 'hidden';
}

function resetAdminForm() {
  document.getElementById('adminFormTitle').textContent = 'Novi dogadjaj';
  document.getElementById('adminEventId').value = '';
  document.getElementById('adminEventTitle').value = '';
  document.getElementById('adminEventRestaurant').value = 'all';
  document.getElementById('adminEventCategory').value = 'akcija';
  document.getElementById('adminEventStart').value = '';
  document.getElementById('adminEventEnd').value = '';
  document.getElementById('adminEventDesc').value = '';
  adminImageData = '';
  renderAdminImagePreview();
}

function editAdminEvent(eventId) {
  const ev = allEvents.find(e => e.id === eventId);
  if (!ev) return;
  document.getElementById('adminFormTitle').textContent = 'Uredi dogadjaj';
  document.getElementById('adminEventId').value = ev.id || '';
  document.getElementById('adminEventTitle').value = ev.title || '';
  document.getElementById('adminEventRestaurant').value = ev.restaurant || 'all';
  document.getElementById('adminEventCategory').value = ev.category || 'akcija';
  document.getElementById('adminEventStart').value = ev.startDate || '';
  document.getElementById('adminEventEnd').value = ev.endDate || '';
  document.getElementById('adminEventDesc').value = ev.description || '';
  adminImageData = ev.imageDataUrl || '';
  renderAdminImagePreview();
}

async function saveAdminEvent() {
  const title = document.getElementById('adminEventTitle').value.trim();
  const startDate = document.getElementById('adminEventStart').value;
  const endDate = document.getElementById('adminEventEnd').value;
  if (!title || !startDate || !endDate) {
    alert('Naziv, datum od i datum do su obavezni.');
    return;
  }
  if (endDate < startDate) {
    alert('Datum do ne moze biti prije datuma od.');
    return;
  }

  const id = document.getElementById('adminEventId').value || `evt_${Date.now()}`;
  const existing = allEvents.find(e => e.id === id);
  const nowIso = new Date().toISOString();
  const eventData = {
    id,
    title,
    restaurant: document.getElementById('adminEventRestaurant').value,
    category: document.getElementById('adminEventCategory').value,
    startDate,
    endDate,
    description: document.getElementById('adminEventDesc').value.trim(),
    imageDataUrl: adminImageData || '',
    createdAt: (existing && existing.createdAt) || (existing && existing.updatedAt) || nowIso,
    updatedAt: nowIso
  };

  try {
    await DataStore.upsertEvent(eventData);
    allEvents = await DataStore.getEvents();
    applyFilter();
    resetAdminForm();
  } catch (err) {
    console.error('Save event failed:', err);
    alert('Spremanje nije uspjelo. Provjerite Firestore/API postavke.');
  }
}

async function deleteAdminEvent(eventId) {
  if (!confirm('Obrisati ovaj dogadjaj?')) return;
  try {
    await DataStore.deleteEvent(eventId);
    allEvents = await DataStore.getEvents();
    applyFilter();
  } catch (err) {
    console.error('Delete event failed:', err);
    alert('Brisanje nije uspjelo. Provjerite Firestore/API postavke.');
  }
}

function setAdminSearchTerm(value) {
  adminSearchTerm = (value || '').trim().toLowerCase();
  renderAdminEvents();
}

function parseDateToMs(value) {
  if (!value) return NaN;
  const ms = Date.parse(value);
  return Number.isNaN(ms) ? NaN : ms;
}

function getEventSortScore(ev) {
  const updated = parseDateToMs(ev.updatedAt);
  if (!Number.isNaN(updated)) return updated;
  const created = parseDateToMs(ev.createdAt);
  if (!Number.isNaN(created)) return created;
  if (ev.id && /^evt_\d+$/.test(ev.id)) return Number(ev.id.slice(4));
  const start = parseDateToMs(ev.startDate);
  if (!Number.isNaN(start)) return start;
  return 0;
}

function eventMatchesSearch(ev, term) {
  if (!term) return true;
  const cat = CONFIG.categories[ev.category] || CONFIG.categories.posebna;
  const rest = CONFIG.restaurants[ev.restaurant] || ev.restaurant || '';
  const hay = [
    ev.title,
    ev.description,
    ev.category,
    cat && cat.label,
    rest,
    ev.startDate,
    ev.endDate
  ].join(' ').toLowerCase();
  return hay.includes(term);
}

function renderAdminEvents() {
  const list = document.getElementById('adminEventsList');
  if (!list) return;

  const sorted = [...allEvents]
    .filter((ev) => eventMatchesSearch(ev, adminSearchTerm))
    .sort((a, b) => getEventSortScore(b) - getEventSortScore(a));
  if (!sorted.length) {
    list.innerHTML = adminSearchTerm
      ? '<div class="admin-empty">Nema rezultata za ovu pretragu.</div>'
      : '<div class="admin-empty">Nema dogadjaja.</div>';
    return;
  }

  list.innerHTML = sorted.map((ev) => {
    const cat = CONFIG.categories[ev.category] || CONFIG.categories.posebna;
    const rest = CONFIG.restaurants[ev.restaurant] || ev.restaurant || 'Svi restorani';
    return `<div class="admin-item">
      <h4>${ev.title}</h4>
      <div class="admin-meta">${cat.label} | ${rest} | ${formatDate(ev.startDate)} - ${formatDate(ev.endDate)}</div>
      <div class="admin-item-actions">
        <button class="admin-small edit" onclick="editAdminEvent('${ev.id}')">Uredi</button>
        <button class="admin-small del" onclick="deleteAdminEvent('${ev.id}')">Obrisi</button>
      </div>
    </div>`;
  }).join('');
}

function setupAdminUpload() {
  const zone = document.getElementById('adminDropzone');
  const input = document.getElementById('adminImageInput');
  if (!zone || !input) return;
  if (zone.dataset.bound === '1') return;
  zone.dataset.bound = '1';

  zone.addEventListener('click', () => input.click());
  input.addEventListener('change', async (e) => {
    const file = e.target.files && e.target.files[0];
    if (file) await handleAdminImageFile(file);
    input.value = '';
  });

  zone.addEventListener('dragover', (e) => {
    e.preventDefault();
    zone.classList.add('dragover');
  });
  zone.addEventListener('dragleave', () => zone.classList.remove('dragover'));
  zone.addEventListener('drop', async (e) => {
    e.preventDefault();
    zone.classList.remove('dragover');
    const file = e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files[0];
    if (file) await handleAdminImageFile(file);
  });
}

async function handleAdminImageFile(file) {
  if (!file.type || !file.type.startsWith('image/')) {
    alert('Odaberite sliku (JPG, PNG, WEBP...).');
    return;
  }
  const hint = document.getElementById('adminDropHint');
  if (hint) hint.textContent = 'Obrada slike...';
  try {
    adminImageData = await compressImageToDataUrl(file, 700000);
    renderAdminImagePreview();
  } catch (err) {
    console.error('Image upload failed:', err);
    alert(err.message || 'Upload slike nije uspio.');
  } finally {
    if (hint) hint.textContent = 'Prevuci sliku ovdje ili klikni za upload.';
  }
}

function removeAdminImage() {
  adminImageData = '';
  renderAdminImagePreview();
}

function renderAdminImagePreview() {
  const img = document.getElementById('adminImagePreview');
  if (!img) return;
  if (adminImageData) {
    img.src = adminImageData;
    img.style.display = 'block';
  } else {
    img.src = '';
    img.style.display = 'none';
  }
}

function readFileAsDataUrl(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = () => resolve(reader.result);
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}

function loadImageFromDataUrl(dataUrl) {
  return new Promise((resolve, reject) => {
    const img = new Image();
    img.onload = () => resolve(img);
    img.onerror = reject;
    img.src = dataUrl;
  });
}

async function compressImageToDataUrl(file, maxLen) {
  const originalDataUrl = await readFileAsDataUrl(file);
  const img = await loadImageFromDataUrl(originalDataUrl);
  const maxSide = 1400;

  let w = img.width;
  let h = img.height;
  const ratio = Math.min(1, maxSide / Math.max(w, h));
  w = Math.max(1, Math.round(w * ratio));
  h = Math.max(1, Math.round(h * ratio));

  const canvas = document.createElement('canvas');
  canvas.width = w;
  canvas.height = h;
  const ctx = canvas.getContext('2d');
  ctx.drawImage(img, 0, 0, w, h);

  const qualities = [0.86, 0.76, 0.66, 0.56, 0.48];
  for (const q of qualities) {
    const data = canvas.toDataURL('image/jpeg', q);
    if (data.length <= maxLen) return data;
  }
  throw new Error('Slika je prevelika. Koristite manju sliku.');
}

// ============================================================
// MODALS
// ============================================================
function showEventDetail(eventId) {
  const ev = allEvents.find(e => e.id === eventId);
  if (!ev) return;
  
  const cat = CONFIG.categories[ev.category] || CONFIG.categories.posebna;
  const restName = ev.restaurant === 'all' ? 'Svi restorani' : (CONFIG.restaurants[ev.restaurant] || ev.restaurant);
  
  const startF = formatDate(ev.startDate);
  const endF = formatDate(ev.endDate);
  const dateDisplay = ev.startDate === ev.endDate ? startF : `${startF} ‚Äî ${endF}`;
  
  document.getElementById('eventModalContent').innerHTML = `
    <div class="modal-banner" style="background:${cat.color}">
      <button class="modal-close" onclick="closeAllModals()">‚úï</button>
      <div class="cat-badge">${cat.icon} ${cat.label}</div>
      <h2>${ev.title}</h2>
    </div>
    <div class="modal-body">
      <div class="modal-info">
        <span class="icon">üìç</span>
        <div><div class="label">Restoran</div><div class="value">${restName}</div></div>
      </div>
      <div class="modal-info">
        <span class="icon">üìÖ</span>
        <div><div class="label">Datum</div><div class="value">${dateDisplay}</div></div>
      </div>
      ${ev.imageDataUrl ? `<div class="modal-attachment"><img src="${ev.imageDataUrl}" alt="Attachment"></div>` : ''}
      ${ev.description ? `<div class="modal-desc">${ev.description}</div>` : ''}
    </div>`;
  
  document.getElementById('eventModal').classList.add('active');
  document.body.style.overflow = 'hidden';
}

function showDayEvents(dateStr) {
  const dayEvents = getEventsForDate(dateStr);
  const d = formatDate(dateStr);
  
  document.getElementById('dayModalContent').innerHTML = `
    <div class="day-modal-title">üìÖ ${d}</div>
    ${dayEvents.map(ev => {
      const cat = CONFIG.categories[ev.category] || CONFIG.categories.posebna;
      return `<div class="day-event-item" onclick="closeAllModals();showEventDetail('${ev.id}')">
        <div class="day-event-dot" style="background:${cat.color}"></div>
        <div class="day-event-info">
          <h4>${cat.icon} ${ev.title}</h4>
          <p>${CONFIG.restaurants[ev.restaurant] || 'Svi restorani'}</p>
        </div>
      </div>`;
    }).join('')}`;
  
  document.getElementById('dayModal').classList.add('active');
  document.body.style.overflow = 'hidden';
}

function showDayEventsPopup(e, dateStr) {
  if (e && e.stopPropagation) e.stopPropagation();
  hideDayEventsPopup();

  const dayEvents = getEventsForDate(dateStr);
  if (!dayEvents.length) return;

  const trigger = (e && (e.currentTarget || e.target)) || null;
  const rect = trigger
    ? trigger.getBoundingClientRect()
    : { left: window.innerWidth / 2, top: window.innerHeight / 2, bottom: window.innerHeight / 2 };

  const popup = document.createElement('div');
  popup.className = 'more-events-popup';
  popup.innerHTML = `
    <div class="more-events-popup-head">üìÖ ${formatDate(dateStr)} (${dayEvents.length})</div>
    <div class="more-events-popup-list">
      ${dayEvents.map(ev => {
        const cat = CONFIG.categories[ev.category] || CONFIG.categories.posebna;
        return `<div class="more-events-popup-item" style="background:${cat.color}" data-event-id="${ev.id}">
          ${cat.icon} ${ev.title}
        </div>`;
      }).join('')}
    </div>
  `;

  document.body.appendChild(popup);
  dayEventsPopupEl = popup;

  popup.querySelectorAll('.more-events-popup-item').forEach((item) => {
    item.addEventListener('click', () => {
      hideDayEventsPopup();
      showEventDetail(item.dataset.eventId);
    });
  });

  if (isCompactMobile()) {
    popup.classList.add('mobile');
    popup.style.left = '12px';
    popup.style.top = '50%';
    return;
  }

  const margin = 8;
  const popupRect = popup.getBoundingClientRect();
  let left = rect.left;
  let top = rect.bottom + margin;

  if (left + popupRect.width > window.innerWidth - margin) {
    left = window.innerWidth - popupRect.width - margin;
  }
  if (top + popupRect.height > window.innerHeight - margin) {
    top = rect.top - popupRect.height - margin;
  }
  if (top < margin) top = margin;
  if (left < margin) left = margin;

  popup.style.left = `${left}px`;
  popup.style.top = `${top}px`;
}

function hideDayEventsPopup() {
  if (dayEventsPopupEl) {
    dayEventsPopupEl.remove();
    dayEventsPopupEl = null;
  }
}

function closeModal(e) {
  if (e.target.classList.contains('modal-overlay')) closeAllModals();
}
function closeAllModals() {
  hideDayEventsPopup();
  document.querySelectorAll('.modal-overlay').forEach(m => m.classList.remove('active'));
  document.body.style.overflow = '';
}

function formatDate(dateStr) {
  const [y, m, d] = dateStr.split('-');
  return `${parseInt(d)}. ${MONTH_NAMES[parseInt(m)-1]} ${y}`;
}

// Keyboard close
document.addEventListener('click', (e) => {
  if (dayEventsPopupEl && !dayEventsPopupEl.contains(e.target) && !e.target.classList.contains('more-events')) {
    hideDayEventsPopup();
  }
});
document.addEventListener('keydown', e => {
  if (e.key === 'Escape') {
    hideDayEventsPopup();
    closeAllModals();
  }
});

// Start
init();
</script>
</body>
</html>
